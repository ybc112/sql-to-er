# Nginx配置 - 每天100用户优化版
# 针对小规模访问量优化的配置

server {
    listen 80;
    server_name ybcybcybc.xyz www.ybcybcybc.xyz;  # 替换为实际域名
    
    # 网站根目录
    root /www/wwwroot/ybcybcybc.xyz/sql4;
    index index.html index.htm;
    
    # 日志文件 - 优化：减少日志写入
    access_log /www/wwwlogs/ybcybcybc.xyz.log combined buffer=64k flush=5m;
    error_log /www/wwwlogs/ybcybcybc.xyz.error.log warn;
    
    # 客户端配置 - 针对小文件优化
    client_max_body_size 8M;  # 降低到8MB，节省内存
    client_body_buffer_size 128k;
    client_header_buffer_size 4k;
    large_client_header_buffers 4 8k;
    
    # 静态文件处理 - 长期缓存
    location /static/ {
        alias /www/wwwroot/ybcybcybc.xyz/sql4/sql_to_er/web_app/static/;
        expires 7d;  # 7天缓存
        add_header Cache-Control "public, immutable";
        
        # Gzip压缩
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/css application/javascript text/javascript;
    }
    
    # ER图输出文件 - 中期缓存
    location /output/ {
        alias /www/wwwroot/ybcybcybc.xyz/sql4/sql_to_er/web_app/output/;
        expires 1d;  # 1天缓存
        add_header Cache-Control "public";
        
        # 图片压缩
        gzip on;
        gzip_types image/svg+xml;
    }
    
    # 上传文件处理
    location /uploads/ {
        alias /www/wwwroot/ybcybcybc.xyz/sql4/uploads/;
        expires 1h;
    }
    
    # API限流 - 防止滥用
    location /api/ {
        # 限制每个IP每分钟10个请求
        limit_req zone=api burst=5 nodelay;
        
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置 - 适应ER图渲染
        proxy_connect_timeout 30s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;
        
        # 缓冲设置 - 小内存优化
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 4 4k;
        proxy_busy_buffers_size 8k;
    }
    
    # 主应用代理
    location / {
        # 基础限流
        limit_req zone=general burst=10 nodelay;
        
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;
        
        # 缓冲设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 4 4k;
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }
    
    # 禁止访问敏感文件
    location ~ /\. {
        deny all;
    }
    
    location ~ \.(py|pyc|pyo)$ {
        deny all;
    }
}

# 限流配置
http {
    # 定义限流区域
    limit_req_zone $binary_remote_addr zone=general:10m rate=30r/m;  # 每分钟30个请求
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/m;      # API每分钟10个请求
    
    # 基础优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 30;  # 降低keepalive时间
    types_hash_max_size 2048;
    
    # Gzip全局配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        image/svg+xml;
}