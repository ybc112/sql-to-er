<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿›åº¦æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-container {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            margin-top: 10px;
            font-weight: bold;
        }
        .progress-message {
            margin-top: 5px;
            color: #666;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ è®ºæ–‡ç”Ÿæˆç³»ç»Ÿä¿®å¤æµ‹è¯•</h1>

    <div class="test-section">
        <h2>ğŸ¯ ä¿®å¤å†…å®¹è¯´æ˜</h2>
        <ul>
            <li>âœ… <strong>æ›´å¤šAPIè°ƒç”¨</strong> - æ¯ä¸ªå°èŠ‚ï¼ˆ4.1ã€4.2ç­‰ï¼‰å•ç‹¬è°ƒç”¨API</li>
            <li>âœ… <strong>æ›´å¤štokenåˆ†é…</strong> - å¤§å¹…å¢åŠ tokené™åˆ¶ç¡®ä¿å­—æ•°å……è¶³</li>
            <li>âœ… <strong>å¼•ç”¨ç¼–å·è¿ç»­æ€§</strong> - å…¨æ–‡å¼•ç”¨ç¼–å·è¿ç»­ï¼Œä¸é‡ç½®</li>
            <li>âœ… <strong>å‚è€ƒæ–‡çŒ®ä¸€è‡´æ€§</strong> - ä¸æ­£æ–‡å¼•ç”¨åŒ¹é…</li>
            <li>âœ… <strong>åˆ é™¤ç¡¬ç¼–ç ä¸šåŠ¡é€»è¾‘</strong> - ä¸å†å†™æ­»"æ ¡å‹ç®¡ç†"ç­‰å†…å®¹</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“‹ ç›®å½•ç”Ÿæˆæµ‹è¯•</h2>
        <button id="testOutlineBtn" onclick="testOutlineGeneration()">æµ‹è¯•ç›®å½•ç”Ÿæˆ</button>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="outlineProgressFill"></div>
            </div>
            <div class="progress-text" id="outlineProgressText">0%</div>
            <div class="progress-message" id="outlineProgressMessage">ç­‰å¾…å¼€å§‹...</div>
        </div>
        <div class="log" id="outlineLog"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ è®ºæ–‡ç”Ÿæˆæµ‹è¯•</h2>
        <button id="testPaperBtn" onclick="testPaperGeneration()">æµ‹è¯•è®ºæ–‡ç”Ÿæˆ</button>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="paperProgressFill"></div>
            </div>
            <div class="progress-text" id="paperProgressText">0%</div>
            <div class="progress-message" id="paperProgressMessage">ç­‰å¾…å¼€å§‹...</div>
        </div>
        <div class="log" id="paperLog"></div>
    </div>

    <script>
        let outlineTaskId = null;
        let paperTaskId = null;

        function log(elementId, message) {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function testOutlineGeneration() {
            const btn = document.getElementById('testOutlineBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';
            
            const progressFill = document.getElementById('outlineProgressFill');
            const progressText = document.getElementById('outlineProgressText');
            const progressMessage = document.getElementById('outlineProgressMessage');
            
            // æ¸…ç©ºæ—¥å¿—
            document.getElementById('outlineLog').innerHTML = '';
            
            try {
                log('outlineLog', 'å¼€å§‹æµ‹è¯•ç›®å½•ç”Ÿæˆ...');
                
                // è°ƒç”¨ç›®å½•ç”ŸæˆAPI
                const response = await fetch('/api/generate-intelligent-outline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'åŸºäºæ·±åº¦å­¦ä¹ çš„å›¾åƒè¯†åˆ«ç³»ç»Ÿè®¾è®¡ä¸å®ç°',
                        field: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯',
                        paper_type: 'æœ¬ç§‘æ¯•ä¸šè®ºæ–‡',
                        total_words: 12000,
                        abstract: 'æœ¬æ–‡è®¾è®¡å¹¶å®ç°äº†ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ çš„å›¾åƒè¯†åˆ«ç³»ç»Ÿï¼Œé‡‡ç”¨å·ç§¯ç¥ç»ç½‘ç»œæŠ€æœ¯ï¼Œå®ç°äº†é«˜ç²¾åº¦çš„å›¾åƒåˆ†ç±»åŠŸèƒ½ã€‚',
                        keywords: 'æ·±åº¦å­¦ä¹ ,å›¾åƒè¯†åˆ«,å·ç§¯ç¥ç»ç½‘ç»œ,æœºå™¨å­¦ä¹ ',
                        special_requirements: 'éœ€è¦åŒ…å«ç³»ç»Ÿè®¾è®¡ã€ç®—æ³•å®ç°ã€æ€§èƒ½æµ‹è¯•ç­‰å†…å®¹',
                        outline_level: 'two'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    outlineTaskId = result.task_id;
                    log('outlineLog', `ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼ŒID: ${outlineTaskId}`);
                    
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    pollOutlineProgress(outlineTaskId, progressFill, progressText, progressMessage);
                } else {
                    throw new Error(result.message || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                log('outlineLog', `é”™è¯¯: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯•ç›®å½•ç”Ÿæˆ';
            }
        }

        async function pollOutlineProgress(taskId, progressFill, progressText, progressMessage) {
            const poll = async () => {
                try {
                    const response = await fetch(`/api/outline-progress/${taskId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const progress = data.progress || 0;
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${progress}%`;
                        progressMessage.textContent = data.message || 'å¤„ç†ä¸­...';
                        
                        log('outlineLog', `è¿›åº¦: ${progress}%, çŠ¶æ€: ${data.status}, æ¶ˆæ¯: ${data.message}`);
                        
                        if (data.status === 'completed') {
                            log('outlineLog', 'ç›®å½•ç”Ÿæˆå®Œæˆï¼');
                            log('outlineLog', `ç”Ÿæˆçš„ç« èŠ‚æ•°: ${data.outline ? data.outline.length : 0}`);
                            document.getElementById('testOutlineBtn').disabled = false;
                            document.getElementById('testOutlineBtn').textContent = 'æµ‹è¯•ç›®å½•ç”Ÿæˆ';
                            return;
                        } else if (data.status === 'error') {
                            log('outlineLog', `ç”Ÿæˆå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                            document.getElementById('testOutlineBtn').disabled = false;
                            document.getElementById('testOutlineBtn').textContent = 'æµ‹è¯•ç›®å½•ç”Ÿæˆ';
                            return;
                        }
                        
                        // ç»§ç»­è½®è¯¢
                        setTimeout(poll, 2000);
                    } else {
                        throw new Error(data.message || 'æŸ¥è¯¢è¿›åº¦å¤±è´¥');
                    }
                } catch (error) {
                    log('outlineLog', `è½®è¯¢é”™è¯¯: ${error.message}`);
                    setTimeout(poll, 3000); // å‡ºé”™åå»¶é•¿è½®è¯¢é—´éš”
                }
            };
            
            poll();
        }

        async function testPaperGeneration() {
            const btn = document.getElementById('testPaperBtn');
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';
            
            const progressFill = document.getElementById('paperProgressFill');
            const progressText = document.getElementById('paperProgressText');
            const progressMessage = document.getElementById('paperProgressMessage');
            
            // æ¸…ç©ºæ—¥å¿—
            document.getElementById('paperLog').innerHTML = '';
            
            try {
                log('paperLog', 'å¼€å§‹æµ‹è¯•è®ºæ–‡ç”Ÿæˆ...');
                
                // ä½¿ç”¨ç®€å•çš„è‡ªå®šä¹‰ç›®å½•è¿›è¡Œæµ‹è¯•
                const customOutline = [
                    {"name": "æ‘˜è¦", "words": 300, "description": "ä¸­æ–‡æ‘˜è¦å’Œå…³é”®è¯"},
                    {"name": "ç¬¬1ç«  ç»ªè®º", "words": 1500, "description": "ç ”ç©¶èƒŒæ™¯å’Œæ„ä¹‰"},
                    {"name": "ç¬¬2ç«  ç›¸å…³æŠ€æœ¯", "words": 2000, "description": "æŠ€æœ¯åŸºç¡€ä»‹ç»"},
                    {"name": "ç¬¬3ç«  ç³»ç»Ÿè®¾è®¡", "words": 2500, "description": "ç³»ç»Ÿæ¶æ„è®¾è®¡"},
                    {"name": "ç¬¬4ç«  æ€»ç»“", "words": 800, "description": "å·¥ä½œæ€»ç»“"}
                ];
                
                // è°ƒç”¨è®ºæ–‡ç”ŸæˆAPI - ä½¿ç”¨æ›´è¯¦ç»†çš„æµ‹è¯•æ•°æ®
                const response = await fetch('/api/generate-paper-with-outline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'åŸºäºSpring Bootå’ŒVue.jsçš„åœ¨çº¿æ•™è‚²å¹³å°è®¾è®¡ä¸å®ç°',
                        field: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯',
                        paper_type: 'æœ¬ç§‘æ¯•ä¸šè®ºæ–‡',
                        abstract: 'éšç€åœ¨çº¿æ•™è‚²çš„å¿«é€Ÿå‘å±•ï¼Œæœ¬æ–‡è®¾è®¡å¹¶å®ç°äº†ä¸€ä¸ªåŸºäºSpring Bootåç«¯å’ŒVue.jså‰ç«¯çš„åœ¨çº¿æ•™è‚²å¹³å°ã€‚ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œä½¿ç”¨MySQLæ•°æ®åº“å­˜å‚¨æ•°æ®ï¼Œå®ç°äº†ç”¨æˆ·ç®¡ç†ã€è¯¾ç¨‹ç®¡ç†ã€åœ¨çº¿å­¦ä¹ ã€è€ƒè¯•æµ‹è¯„ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚é€šè¿‡æ€§èƒ½æµ‹è¯•éªŒè¯ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒåƒçº§å¹¶å‘ç”¨æˆ·è®¿é—®ï¼Œå“åº”æ—¶é—´æ§åˆ¶åœ¨500msä»¥å†…ã€‚',
                        keywords: 'Spring Boot,Vue.js,åœ¨çº¿æ•™è‚²,å‰åç«¯åˆ†ç¦»,MySQL',
                        requirements: 'éœ€è¦åŒ…å«è¯¦ç»†çš„ç³»ç»Ÿæ¶æ„è®¾è®¡ã€æ•°æ®åº“è®¾è®¡ã€æ ¸å¿ƒåŠŸèƒ½å®ç°ã€æ€§èƒ½æµ‹è¯•ç­‰å†…å®¹ï¼Œå­—æ•°è¦æ±‚12000å­—ä»¥ä¸Šï¼Œå¼•ç”¨æ–‡çŒ®15ç¯‡ä»¥ä¸Š',
                        custom_outline: customOutline
                    })
                });

                const result = await response.json();
                if (result.success) {
                    paperTaskId = result.task_id;
                    log('paperLog', `ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼ŒID: ${paperTaskId}`);
                    
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    pollPaperProgress(paperTaskId, progressFill, progressText, progressMessage);
                } else {
                    throw new Error(result.message || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                log('paperLog', `é”™è¯¯: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯•è®ºæ–‡ç”Ÿæˆ';
            }
        }

        async function pollPaperProgress(taskId, progressFill, progressText, progressMessage) {
            const poll = async () => {
                try {
                    const response = await fetch(`/api/paper-progress/${taskId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const progress = data.progress || 0;
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${progress}%`;
                        progressMessage.textContent = data.message || 'å¤„ç†ä¸­...';
                        
                        log('paperLog', `è¿›åº¦: ${progress}%, çŠ¶æ€: ${data.status}, æ¶ˆæ¯: ${data.message}`);
                        
                        if (data.status === 'completed') {
                            log('paperLog', 'è®ºæ–‡ç”Ÿæˆå®Œæˆï¼');
                            log('paperLog', `å†…å®¹é•¿åº¦: ${data.content ? data.content.length : 0} å­—ç¬¦`);
                            document.getElementById('testPaperBtn').disabled = false;
                            document.getElementById('testPaperBtn').textContent = 'æµ‹è¯•è®ºæ–‡ç”Ÿæˆ';
                            return;
                        } else if (data.status === 'error') {
                            log('paperLog', `ç”Ÿæˆå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                            document.getElementById('testPaperBtn').disabled = false;
                            document.getElementById('testPaperBtn').textContent = 'æµ‹è¯•è®ºæ–‡ç”Ÿæˆ';
                            return;
                        }
                        
                        // ç»§ç»­è½®è¯¢
                        setTimeout(poll, 2000);
                    } else {
                        throw new Error(data.message || 'æŸ¥è¯¢è¿›åº¦å¤±è´¥');
                    }
                } catch (error) {
                    log('paperLog', `è½®è¯¢é”™è¯¯: ${error.message}`);
                    setTimeout(poll, 3000); // å‡ºé”™åå»¶é•¿è½®è¯¢é—´éš”
                }
            };
            
            poll();
        }
    </script>
</body>
</html>
