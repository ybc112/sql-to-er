<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员仪表盘 - SQL转ER图工具</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        
        /* 侧边栏样式 */
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #343a40;
            width: 250px;
        }
        
        .sidebar-sticky {
            position: sticky;
            top: 48px;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            font-weight: 500;
            color: #adb5bd;
            padding: 10px 20px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link.active {
            color: #fff;
            background-color: #007bff;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* 主内容区域 */
        .main {
            margin-left: 250px;
            padding: 20px;
        }
        
        /* 顶部导航栏 */
        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
            padding: 15px 20px;
            margin-bottom: 30px;
        }
        
        /* 统计卡片 */
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,.15);
        }
        
        .stat-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }
        
        .stat-card.blue .icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.green .icon { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.orange .icon { background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%); }
        .stat-card.red .icon { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }
        
        .stat-card h3 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
        }
        
        .stat-card p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .stat-card .change {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .stat-card .change.positive { color: #28a745; }
        .stat-card .change.negative { color: #dc3545; }
        
        /* 图表卡片 */
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
            margin-bottom: 20px;
        }
        
        .chart-card h5 {
            margin-bottom: 20px;
            color: #333;
        }
        
        /* 图表容器 */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* 表格样式 */
        .table-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
            margin-bottom: 20px;
        }
        
        .table-card h5 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .table thead {
            background-color: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <nav class="sidebar">
        <div class="sidebar-sticky">
            <div class="text-center text-white mb-4">
                <i class="fas fa-user-shield fa-3x mb-2"></i>
                <h5>管理员后台</h5>
                <small>{{ admin_info.username }}</small>
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('admin.dashboard') }}">
                        <i class="fas fa-tachometer-alt"></i>
                        仪表盘
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.users') }}">
                        <i class="fas fa-users"></i>
                        用户管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.announcements') }}">
                        <i class="fas fa-bullhorn"></i>
                        公告管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.settings') }}">
                        <i class="fas fa-cog"></i>
                        系统设置
                    </a>
                </li>
            </ul>
            
            <hr class="text-white">
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('homepage') }}">
                        <i class="fas fa-home"></i>
                        返回首页
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.logout') }}">
                        <i class="fas fa-sign-out-alt"></i>
                        退出登录
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- 主内容区域 -->
    <main class="main">
        <!-- 顶部导航 -->
        <nav class="navbar">
            <div class="d-flex justify-content-between align-items-center w-100">
                <h4 class="mb-0">仪表盘</h4>
                <div class="text-muted">
                    <i class="far fa-clock me-1"></i>
                    <span id="current-time"></span>
                </div>
            </div>
        </nav>
        
        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card blue">
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 id="total-users">{{ stats.users.total_users }}</h3>
                    <p>总用户数</p>
                    <div class="change positive">
                        <i class="fas fa-arrow-up"></i>
                        今日新增 {{ stats.users.today_new_users }}
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card green">
                    <div class="icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <h3>¥{{ "%.2f"|format(stats.finance.total_revenue) }}</h3>
                    <p>总收入</p>
                    <div class="change positive">
                        <i class="fas fa-arrow-up"></i>
                        今日 ¥{{ "%.2f"|format(stats.finance.today_revenue) }}
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card orange">
                    <div class="icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <h3>{{ stats.users.active_users }}</h3>
                    <p>活跃用户</p>
                    <div class="change">
                        最近7天登录
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card red">
                    <div class="icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>{{ stats.services.today_usage }}</h3>
                    <p>今日服务调用</p>
                    <div class="change">
                        <i class="fas fa-info-circle"></i>
                        在线 {{ stats.activity.online_users }} 人
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="row">
            <!-- 服务使用情况 -->
            <div class="col-md-6">
                <div class="chart-card">
                    <h5>服务使用统计</h5>
                    <div class="chart-container">
                        <canvas id="serviceChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 收入趋势 -->
            <div class="col-md-6">
                <div class="chart-card">
                    <h5>最近7天收入统计</h5>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 额外统计信息 -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="table-card">
                    <h5>收入概况</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">¥{{ "%.2f"|format(stats.finance.total_consumption) }}</h4>
                                <p class="text-muted mb-0">总消费额</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">¥{{ "%.2f"|format(stats.finance.month_revenue) }}</h4>
                                <p class="text-muted mb-0">本月收入</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">{{ stats.users.month_new_users }}</h4>
                                <p class="text-muted mb-0">本月新用户</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">{{ "%.1f"|format((stats.users.active_users / stats.users.total_users * 100) if stats.users.total_users > 0 else 0) }}%</h4>
                                <p class="text-muted mb-0">用户活跃率</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 表格区域 -->
        <div class="row">
            <!-- 最近交易 -->
            <div class="col-md-6">
                <div class="table-card">
                    <h5>最近充值记录</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>用户</th>
                                    <th>金额</th>
                                    <th>状态</th>
                                    <th>时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trans in stats.recent_transactions %}
                                <tr>
                                    <td>{{ trans.username or '未知' }}</td>
                                    <td>¥{{ "%.2f"|format(trans.amount) }}</td>
                                    <td>
                                        {% if trans.status == 'success' %}
                                            <span class="badge bg-success">成功</span>
                                        {% elif trans.status == 'pending' %}
                                            <span class="badge bg-warning">待支付</span>
                                        {% else %}
                                            <span class="badge bg-danger">失败</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ trans.paid_at.strftime('%m-%d %H:%M') if trans.paid_at else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 最近用户 -->
            <div class="col-md-6">
                <div class="table-card">
                    <h5>最近注册用户</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>用户名</th>
                                    <th>邮箱</th>
                                    <th>余额</th>
                                    <th>注册时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in stats.recent_users %}
                                <tr>
                                    <td>{{ user.username or '未设置' }}</td>
                                    <td>{{ user.email or '-' }}</td>
                                    <td>¥{{ "%.2f"|format(user.balance) }}</td>
                                    <td>{{ user.created_at.strftime('%m-%d %H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 系统信息 -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="table-card">
                    <h5>系统概况</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>论文生成总数：</strong> {{ stats.services.total_papers }}</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>答辩问题总数：</strong> {{ stats.services.total_defense_questions }}</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>今日登录次数：</strong> {{ stats.activity.today_logins }}</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>用户总余额：</strong> ¥{{ "%.2f"|format(stats.finance.total_balance) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // 显示当前时间
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = timeString;
        }
        
        updateTime();
        setInterval(updateTime, 1000);
        
        // 保存图表实例
        let serviceChart = null;
        let revenueChart = null;
        
        // 初始化图表
        function initCharts() {
            // 销毁旧图表
            if (serviceChart) {
                serviceChart.destroy();
            }
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            // 服务使用图表
            const serviceData = {{ stats.services.service_usage | tojson }};
            const serviceCtx = document.getElementById('serviceChart').getContext('2d');
            serviceChart = new Chart(serviceCtx, {
                type: 'doughnut',
                data: {
                    labels: serviceData.map(s => {
                        const names = {
                            'sql_to_er': 'SQL转ER图',
                            'defense_questions': '答辩问题',
                            'paper_generation': '论文生成',
                            'ai_translation': 'AI翻译',
                            'er_optimization': 'ER优化',
                            'database_design': '数据库设计'
                        };
                        return names[s.service_type] || s.service_type;
                    }),
                    datasets: [{
                        data: serviceData.map(s => s.count),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#feca57',
                            '#48dbfb'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // 收入趋势图表 - 使用最近7天的真实数据
            const revenueData = {{ stats.finance.daily_revenue | tojson }};
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            
            // 生成最近7天的日期
            const last7Days = [];
            const revenueMap = {};
            
            // 将数据转换为map便于查找
            revenueData.forEach(item => {
                revenueMap[item.date] = item.revenue;
            });
            
            // 生成最近7天的日期和数据
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const monthDay = (date.getMonth() + 1) + '月' + date.getDate() + '日';
                labels.push(monthDay);
                data.push(revenueMap[dateStr] || 0);
            }
            
            revenueChart = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '收入金额',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '收入: ¥' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 页面加载时初始化图表
        document.addEventListener('DOMContentLoaded', initCharts);
        
        // 定时刷新数据
        setInterval(() => {
            fetch('/admin/api/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新统计数据
                        document.getElementById('total-users').textContent = data.data.total_users || 0;
                        // 可以更新其他数据...
                    }
                });
        }, 30000); // 30秒刷新一次
    </script>
</body>
</html>